<div class="services-container">
  <!-- Plan Usage Banner -->
  <div class="alert mb-4" [class]="getPlanAlertClass()">
    <div class="d-flex justify-content-between align-items-start">
      <div class="flex-grow-1">
        <h5 class="mb-2">
          <i class="bi bi-trophy me-2"></i>
          {{ userPlan.type.toUpperCase() || 'FREE' }} Plan
        </h5>
        <div class="row g-3">
          <div class="col-md-6 col-lg-3">
            <div class="usage-stat">
              <small class="text-muted d-block">Active Keys</small>
              <strong>{{ currentUsage }} / {{ getPlanLimitDisplay() }}</strong>
              @if (!isPlanUnlimited() && hasRemainingKeys()) {
                <small class="text-muted">({{ getRemainingKeysCount() }} remaining)</small>
              }
            </div>
          </div>
          <div class="col-md-6 col-lg-3">
            <div class="usage-stat">
              <small class="text-muted d-block">This Month</small>
              <strong>{{ keysCreatedThisMonth }}</strong>
              @if (getMonthlyRemainingCreations() !== 'unlimited') {
                <small class="text-muted">({{ getMonthlyRemainingCreations() }} remaining)</small>
              } @else {
                <small class="text-muted">(unlimited)</small>
              }
            </div>
          </div>
          <div class="col-md-6 col-lg-3">
            <div class="usage-stat">
              <small class="text-muted d-block">Total Created</small>
              <strong>{{ totalKeysCreated }}</strong>
              @if (getTotalRemainingCreations() !== 'unlimited') {
                <small class="text-muted">({{ getTotalRemainingCreations() }} remaining)</small>
              } @else {
                <small class="text-muted">(unlimited)</small>
              }
            </div>
          </div>
          <div class="col-md-6 col-lg-3">
            <div class="usage-stat">
              <small class="text-muted d-block">Archived</small>
              <strong>{{ archivedKeysCount }}</strong>
              <small class="text-muted">(total)</small>
            </div>
          </div>
        </div>
      </div>
      @if (!canCreateMoreKeys()) {
        <button class="btn btn-warning btn-sm ms-3" (click)="showUpgradeModal()">
          <i class="bi bi-arrow-up-circle me-1"></i>Upgrade Plan
        </button>
      }
    </div>
  </div>

  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2>API Keys</h2>
      <p class="text-muted">Manage your API keys for analytics tracking</p>
    </div>
    <div class="d-flex gap-2">
      @if (archivedKeysCount > 0) {
        <button class="btn btn-outline-secondary" (click)="toggleArchivedKeys()">
          <i class="bi" [class]="showArchivedKeys ? 'bi-eye-slash' : 'bi-eye'"></i>
          {{ showArchivedKeys ? 'Hide' : 'Show' }} Archived Keys
        </button>
      }
      <!-- Environment Toggle -->
      <div class="d-flex flex-column align-items-end">
        <div class="btn-group" role="group">
          <button type="button" class="btn" 
                  [class]="selectedEnvironment === 'development' ? 'btn-warning' : 'btn-outline-warning'"
                  (click)="toggleEnvironment()"
                  [disabled]="selectedEnvironment === 'development'">
            <i class="bi bi-code-slash me-1"></i>Development
          </button>
          <button type="button" class="btn" 
                  [class]="selectedEnvironment === 'production' ? 'btn-success' : 'btn-outline-success'"
                  (click)="toggleEnvironment()"
                  [disabled]="selectedEnvironment === 'production'">
            <i class="bi bi-rocket me-1"></i>Production
          </button>
        </div>
        
      </div>
      
      <button class="btn btn-primary" (click)="openCreateModal(createModal)" [disabled]="!canCreateMoreKeys()">
        <i class="bi bi-plus-circle me-2"></i>
        @if (canCreateMoreKeys()) {
          Create API Key
        } @else {
          @if (!checkActiveKeysLimit()) {
            <i class="bi bi-lock me-2"></i>Active Keys Limit Reached
          } @else if (!checkMonthlyCreationLimit()) {
            <i class="bi bi-calendar-x me-2"></i>Monthly Limit Reached
          } @else if (!checkTotalCreationLimit()) {
            <i class="bi bi-exclamation-triangle me-2"></i>Total Limit Reached
          } @else {
            <i class="bi bi-lock me-2"></i>Plan Limit Reached
          }
        }
      </button>
    </div>
  </div>

  <!-- Environment Instructions -->
  <div class="alert alert-info mt-2">
    <strong>Environment Info:</strong> Use <strong>Development</strong> for testing and debugging your analytics integration. Switch to <strong>Production</strong> when you're ready to track live data. API keys are environment-specific and data is isolated between environments.
  </div>

  <!-- Loading State -->
  @if (isLoading) {
    <div class="text-center py-5">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-2">Loading API keys...</p>
    </div>
  }

  <!-- API Keys Table -->
  @if (!isLoading && getDisplayedKeys().length > 0) {
    <div class="table-responsive">
      <table class="table table-hover">
        <thead class="table-dark">
          <tr>
            <th scope="col">
              <i class="bi bi-tag me-2"></i>Name
            </th>
            <th scope="col">
              <i class="bi bi-key me-2"></i>API Key
            </th>
            <th scope="col">
              <i class="bi bi-card-text me-2"></i>Description
            </th>
            <th scope="col">
              <i class="bi bi-globe me-2"></i>Allowed Domains
            </th>
            <th scope="col">
              <i class="bi bi-toggle-on me-2"></i>Status
            </th>
            <th scope="col">
              <i class="bi bi-calendar me-2"></i>Created
            </th>
            <th scope="col" class="text-center">
              <i class="bi bi-gear me-2"></i>Actions
            </th>
          </tr>
        </thead>
        <tbody>
          @for (key of getDisplayedKeys(); track key.apiKey) {
            <tr>
              <td>
                <div class="d-flex align-items-center">
                  <div>
                    <strong class="text-primary">{{ key.name }}</strong>
                  </div>
                </div>
              </td>
              <td>
                <div class="d-flex align-items-center">
                  <code class="me-2 text-truncate" style="max-width: 200px;">{{ key.apiKey || 'API Key not available' }}</code>
                  <button class="btn btn-sm" [class]="copiedApiKey === key.apiKey ? 'btn-success' : 'btn-outline-primary'"
                          type="button" (click)="copyApiKey(key.apiKey)" [disabled]="!key.apiKey"
                          [title]="copiedApiKey === key.apiKey ? 'Copied!' : 'Copy to clipboard'">
                    @if (copiedApiKey === key.apiKey) {
                      <i class="bi bi-check-lg"></i>
                    } @else {
                      <i class="bi bi-clipboard"></i>
                    }
                  </button>
                </div>
              </td>
              <td>
                @if (key.description) {
                  <span class="text-muted">{{ key.description }}</span>
                } @else {
                  <span class="text-muted fst-italic">No description</span>
                }
              </td>
              <td>
                @if (key.allowedDomains && key.allowedDomains.length > 0) {
                  <div class="d-flex flex-wrap gap-1">
                    @for (domain of key.allowedDomains; track domain) {
                      <span class="badge bg-light text-dark border">
                        <i class="bi bi-globe me-1"></i>{{ domain }}
                      </span>
                    }
                  </div>
                } @else {
                  <span class="text-muted fst-italic">
                    <i class="bi bi-unlock me-1"></i>All domains
                  </span>
                }
              </td>
              <td>
                <span class="badge" [class]="key.isActive ? 'bg-success' : 'bg-secondary'">
                  <i class="bi" [class]="key.isActive ? 'bi-check-circle-fill' : 'bi-x-circle-fill'"></i>
                  {{ key.isActive ? 'Active' : 'Archived' }}
                </span>
              </td>
              <td>
                <small class="text-muted">{{ key.createdAt | date:'short' }}</small>
              </td>
              <td class="text-center">
                <div class="btn-group" role="group">
                  <button class="btn btn-sm btn-outline-info" (click)="viewUsage(key.apiKey)"
                          title="View Usage">
                    <i class="bi bi-graph-up"></i>
                  </button>
                  @if (key.isActive) {
                    <button class="btn btn-sm btn-outline-primary" (click)="openEditModal(editModal, key)"
                            title="Edit API Key">
                      <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" (click)="archiveApiKey(key.apiKey)"
                            title="Archive API Key">
                      <i class="bi bi-archive"></i>
                    </button>
                  } @else {
                    <button class="btn btn-sm btn-outline-success" (click)="restoreKey(key)"
                            title="Restore API Key">
                      <i class="bi bi-arrow-counterclockwise"></i>
                    </button>
                  }
                </div>
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>

    <div class="alert alert-info mt-4">
      <i class="bi bi-info-circle me-2"></i>
      <strong>Integration:</strong> Use these API keys in your analytics script configuration.
      Add <code>data-api-key="{{ getActiveKeys()[0]?.apiKey || 'YOUR_API_KEY' }}"</code> to your script tag.
    </div>
  }

  <!-- Archived API Keys Section -->
  @if (showArchivedKeys && archivedKeys.length > 0) {
    <div class="mt-5">
      <h3 class="mb-3">
        <i class="bi bi-archive me-2 text-warning"></i>
        Archived API Keys
      </h3>
      <p class="text-muted">Archived API keys are kept for data access and potential restoration.</p>

      <div class="table-responsive">
        <table class="table table-hover">
          <thead class="table-warning">
            <tr>
              <th scope="col">
                <i class="bi bi-tag me-2"></i>Name
              </th>
              <th scope="col">
                <i class="bi bi-key me-2"></i>API Key
              </th>
              <th scope="col">
                <i class="bi bi-calendar-x me-2"></i>Archived
              </th>
              <th scope="col" class="text-center">
                <i class="bi bi-gear me-2"></i>Actions
              </th>
            </tr>
          </thead>
          <tbody>
            @for (key of archivedKeys; track key.apiKey) {
              <tr>
                <td>
                  <div class="d-flex align-items-center">
                    <div>
                      <strong class="text-muted">{{ key.name }}</strong>
                    </div>
                  </div>
                </td>
                <td>
                  <div class="d-flex align-items-center">
                    <code class="me-2 text-truncate text-muted" style="max-width: 200px;">{{ key.apiKey || 'API Key not available' }}</code>
                    <button class="btn btn-sm btn-outline-secondary"
                            type="button" (click)="copyApiKey(key.apiKey)" [disabled]="!key.apiKey"
                            title="Copy to clipboard">
                      <i class="bi bi-clipboard"></i>
                    </button>
                  </div>
                </td>
                <td>
                  <small class="text-muted">{{ key.createdAt | date:'short' }}</small>
                </td>
                <td class="text-center">
                  <div class="btn-group" role="group">
                    <button class="btn btn-sm btn-outline-info" (click)="viewUsage(key.apiKey)"
                            title="View Usage">
                      <i class="bi bi-graph-up"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-success" (click)="restoreKey(key)"
                            title="Restore API Key" [disabled]="!canCreateMoreKeys()">
                      <i class="bi bi-arrow-counterclockwise"></i>
                    </button>
                  </div>
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    </div>
  }

  <!-- Empty State -->
  @if (!isLoading && apiKeys.length === 0) {
    <div class="text-center py-5">
      <i class="bi bi-key display-1 text-muted mb-3"></i>
      <h4>No API Keys Yet</h4>
      <p class="text-muted">Create your first API key to start tracking analytics.</p>
      <button class="btn btn-primary" (click)="openCreateModal(createModal)" [disabled]="!canCreateMoreKeys()">
        @if (canCreateMoreKeys()) {
          <i class="bi bi-plus-circle me-2"></i>Create Your First API Key
        } @else {
          <i class="bi bi-lock me-2"></i>Upgrade to Create API Keys
        }
      </button>
      @if (!canCreateMoreKeys()) {
        <div class="alert alert-warning mt-3">
          @if (!checkActiveKeysLimit()) {
            <i class="bi bi-info-circle me-2"></i>
            You've reached your {{ userPlan.type }} plan limit of {{ userPlan.apiKeyLimit }} active API keys.
          } @else if (!checkMonthlyCreationLimit()) {
            <i class="bi bi-calendar-x me-2"></i>
            You've created {{ keysCreatedThisMonth }} API keys this month. Monthly limit reached for your {{ userPlan.type }} plan.
          } @else if (!checkTotalCreationLimit()) {
            <i class="bi bi-exclamation-triangle me-2"></i>
            You've created {{ totalKeysCreated }} API keys total. Total limit reached for your {{ userPlan.type }} plan.
          } @else {
            <i class="bi bi-exclamation-triangle me-2"></i>
            You've reached your {{ userPlan.type }} plan limit of {{ userPlan.apiKeyLimit }} API keys.
          }
          <button class="btn btn-warning btn-sm ms-2" (click)="showUpgradeModal()">Upgrade Plan</button>
        </div>
      }
    </div>
  }
</div>

<!-- Create API Key Modal -->
<ng-template #createModal let-modal>
  <div class="modal-header">
    <h5 class="modal-title">Create New API Key</h5>
    <button type="button" class="btn-close" (click)="modal.close()"></button>
  </div>
  <div class="modal-body">
    <form [formGroup]="apiKeyForm" (ngSubmit)="createApiKey()">
      <div class="mb-3">
        <label for="apiKeyName" class="form-label">Name *</label>
        <input
          type="text"
          class="form-control"
          id="apiKeyName"
          formControlName="name"
          placeholder="Enter name"
          [class.is-invalid]="getFormFieldError('name')">
        @if (getFormFieldError('name')) {
          <div class="invalid-feedback">{{ getFormFieldError('name') }}</div>
        }
      </div>
      <div class="mb-3">
        <label for="description" class="form-label">Description</label>
        <textarea
          class="form-control"
          id="description"
          formControlName="description"
          rows="3"
          placeholder="Enter description (optional)"></textarea>
      </div>
      <div class="mb-3">
        <label for="allowedDomains" class="form-label">
          Allowed Domains
          <small class="text-muted">(Optional - Security Feature)</small>
        </label>
        <input
          type="text"
          class="form-control"
          id="allowedDomains"
          formControlName="allowedDomains"
          placeholder="example.com, app.example.com (comma-separated)">
        <div class="form-text">
          <i class="bi bi-shield-check me-1"></i>
          Restrict this API key to specific domains. Leave empty to allow all domains.
          @if (selectedEnvironment === 'development') {
            <strong class="text-info">Development mode: Domain restrictions are bypassed.</strong>
          }
        </div>
      </div>
    </form>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-secondary" (click)="modal.close()">Cancel</button>
    <button type="button" class="btn btn-primary" (click)="createApiKey()" [disabled]="!apiKeyForm.valid">
      <i class="bi bi-plus-circle me-2"></i>Create API Key
    </button>
  </div>
</ng-template>

<!-- Edit API Key Modal -->
<ng-template #editModal let-modal>
  <div class="modal-header">
    <h5 class="modal-title">Edit API Key</h5>
    <button type="button" class="btn-close" (click)="modal.close()"></button>
  </div>
  <div class="modal-body">
    <form [formGroup]="editForm" (ngSubmit)="updateApiKey()">
      <div class="mb-3">
        <label for="editApiKeyName" class="form-label">Name *</label>
        <input
          type="text"
          class="form-control"
          id="editApiKeyName"
          formControlName="name"
          placeholder="Enter name"
          [class.is-invalid]="getEditFormFieldError('name')">
        @if (getEditFormFieldError('name')) {
          <div class="invalid-feedback">{{ getEditFormFieldError('name') }}</div>
        }
      </div>
      <div class="mb-3">
        <label for="editDescription" class="form-label">Description</label>
        <textarea
          class="form-control"
          id="editDescription"
          formControlName="description"
          rows="3"
          placeholder="Enter description (optional)"></textarea>
      </div>
      <div class="mb-3">
        <label for="editAllowedDomains" class="form-label">
          Allowed Domains
          <small class="text-muted">(Optional - Security Feature)</small>
        </label>
        <input
          type="text"
          class="form-control"
          id="editAllowedDomains"
          formControlName="allowedDomains"
          placeholder="example.com, app.example.com (comma-separated)">
        <div class="form-text">
          <i class="bi bi-shield-check me-1"></i>
          Restrict this API key to specific domains. Leave empty to allow all domains.
          @if (selectedEnvironment === 'development') {
            <strong class="text-info">Development mode: Domain restrictions are bypassed.</strong>
          }
        </div>
      </div>
      <div class="mb-3">
        <label class="form-label">Usage Limits (Plan-based)</label>
        <div class="row">
          <div class="col-md-6">
            <div class="form-control-plaintext">
              <small class="text-muted d-block">Daily Limit</small>
              <strong>{{ selectedKey?.limits?.daily || 0 }}</strong> calls/day
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-control-plaintext">
              <small class="text-muted d-block">Monthly Limit</small>
              <strong>{{ selectedKey?.limits?.monthly || 0 }}</strong> calls/month
            </div>
          </div>
        </div>
        <small class="text-muted">Limits are automatically set based on your {{ userPlan.type.toUpperCase() || 'FREE' }} plan</small>
      </div>
    </form>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-secondary" (click)="modal.close()">Cancel</button>
    <button type="button" class="btn btn-primary" (click)="updateApiKey()" [disabled]="!editForm.valid">
      <i class="bi bi-check-circle me-2"></i>Update API Key
    </button>
  </div>
</ng-template>

<!-- View Usage Modal -->
<ng-template #usageModal let-modal>
  <div class="modal-header">
    <h5 class="modal-title">
      <i class="bi bi-graph-up me-2"></i>API Key Usage Details
    </h5>
    <button type="button" class="btn-close" (click)="modal.close()"></button>
  </div>
  <div class="modal-body">
    @if (usage) {
      <div class="row g-4">
        <!-- Usage Limits -->
        <div class="col-12">
          <h6 class="text-muted mb-3">
            <i class="bi bi-shield-check me-1"></i>Usage Limits
          </h6>
          <div class="row g-3">
            <div class="col-md-6">
              <div class="card border-info">
                <div class="card-body text-center">
                  <div class="display-6 text-info">{{ usage.limits.daily }}</div>
                  <small class="text-muted">Daily Limit</small>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="card border-info">
                <div class="card-body text-center">
                  <div class="display-6 text-info">{{ usage.limits.monthly }}</div>
                  <small class="text-muted">Monthly Limit</small>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Current Usage -->
        <div class="col-12">
          <h6 class="text-muted mb-3">
            <i class="bi bi-bar-chart-line me-1"></i>Current Usage
          </h6>
          <div class="row g-3">
            <div class="col-md-6 col-lg-3">
              <div class="card">
                <div class="card-body text-center">
                  <div class="h4 text-primary">{{ usage.usage.daily }}</div>
                  <small class="text-muted">Today</small>
                  @if (usage.limits.daily > 0) {
                    <div class="progress mt-2" style="height: 4px;">
                      <div class="progress-bar" [class]="getUsageProgressClass(usage.usage.daily, usage.limits.daily)"
                           [style.width.%]="(usage.usage.daily / usage.limits.daily) * 100"></div>
                    </div>
                  }
                </div>
              </div>
            </div>
            <div class="col-md-6 col-lg-3">
              <div class="card">
                <div class="card-body text-center">
                  <div class="h4 text-success">{{ usage.usage.weekly }}</div>
                  <small class="text-muted">This Week</small>
                </div>
              </div>
            </div>
            <div class="col-md-6 col-lg-3">
              <div class="card">
                <div class="card-body text-center">
                  <div class="h4 text-warning">{{ usage.usage.monthly }}</div>
                  <small class="text-muted">This Month</small>
                  @if (usage.limits.monthly > 0) {
                    <div class="progress mt-2" style="height: 4px;">
                      <div class="progress-bar" [class]="getUsageProgressClass(usage.usage.monthly, usage.limits.monthly)"
                           [style.width.%]="(usage.usage.monthly / usage.limits.monthly) * 100"></div>
                    </div>
                  }
                </div>
              </div>
            </div>
            <div class="col-md-6 col-lg-3">
              <div class="card">
                <div class="card-body text-center">
                  <div class="h4 text-secondary">{{ usage.usage.total }}</div>
                  <small class="text-muted">Total</small>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Last Used -->
        @if (usage.lastUsed) {
          <div class="col-12">
            <div class="alert alert-light">
              <i class="bi bi-clock-history me-2"></i>
              <strong>Last Used:</strong> {{ usage.lastUsed | date:'medium' }}
            </div>
          </div>
        }

        <!-- Domain Restrictions -->
        <div class="col-12">
          <div class="alert" [class]="usage.allowedDomains && usage.allowedDomains.length > 0 ? 'alert-warning' : 'alert-success'">
            <i class="bi" [class]="usage.allowedDomains && usage.allowedDomains.length > 0 ? 'bi-shield-check' : 'bi-unlock'"></i>
            <strong>Domain Restrictions:</strong>
            @if (usage.allowedDomains && usage.allowedDomains.length > 0) {
              <span>Restricted to {{ usage.allowedDomains.length }} domain(s)</span>
              <div class="mt-2">
                @for (domain of usage.allowedDomains; track domain) {
                  <span class="badge bg-light text-dark me-1">{{ domain }}</span>
                }
              </div>
            } @else {
              <span>All domains allowed</span>
            }
          </div>
        </div>

        <!-- API Key Display -->
        <div class="col-12">
          <div class="input-group">
            <input type="text" class="form-control" [value]="usage.apiKey" readonly>
            <button class="btn btn-outline-secondary" type="button" (click)="copyApiKey(usage.apiKey)">
              <i class="bi bi-clipboard"></i>
            </button>
          </div>
          @if (copiedApiKey === usage.apiKey) {
            <small class="text-success mt-1 d-block">
              <i class="bi bi-check-circle me-1"></i>Copied to clipboard!
            </small>
          }
        </div>

        <!-- Security Notice -->
        <div class="col-12">
          <div class="alert alert-warning">
            <i class="bi bi-shield-exclamation me-2"></i>
            <strong>Security:</strong> If you suspect this key has been compromised,
            use the Archive button to immediately disable it and create a new key.
          </div>
        </div>
      </div>
    } @else {
      <div class="text-center py-4">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2 text-muted">Loading usage data...</p>
      </div>
    }
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-secondary" (click)="modal.close()">Close</button>
  </div>
</ng-template>
